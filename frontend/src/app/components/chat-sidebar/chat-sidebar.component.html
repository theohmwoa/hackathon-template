<div class="chat-sidebar">
  <!-- Project Selector Header -->
  <div class="project-selector">
    <div class="selector-container">
      <select
        class="project-dropdown"
        [(ngModel)]="selectedProject"
        (change)="selectProject(selectedProject!)"
        [disabled]="loadingProjects"
        aria-label="Select project"
      >
        <option [ngValue]="null" disabled>
          {{ loadingProjects ? 'Loading...' : 'Select a project' }}
        </option>
        <option
          *ngFor="let project of projects; trackBy: trackByProjectId"
          [ngValue]="project"
        >
          {{ project.name }}
        </option>
      </select>

      <button
        class="btn-create-project"
        (click)="showCreateProjectDialog()"
        [disabled]="loadingProjects"
        aria-label="Create new project"
        title="Create new project"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 3.5V12.5M3.5 8H12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <!-- Project Error -->
    <div *ngIf="projectError" class="error-banner" role="alert">
      <span class="error-text">{{ projectError }}</span>
      <button class="btn-retry" (click)="loadProjects()" aria-label="Retry loading projects">
        Retry
      </button>
    </div>
  </div>

  <!-- Empty State: No Projects -->
  <div *ngIf="!loadingProjects && projects.length === 0 && !projectError" class="empty-state">
    <div class="empty-icon">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="8" y="12" width="32" height="28" rx="2" stroke="currentColor" stroke-width="2"/>
        <path d="M16 20H32M16 26H28M16 32H24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>
    <p class="empty-title">No projects yet</p>
    <p class="empty-description">Create your first project to start chatting</p>
    <button class="btn-primary" (click)="showCreateProjectDialog()">
      Create Project
    </button>
  </div>

  <!-- Empty State: No Project Selected -->
  <div *ngIf="!loadingProjects && projects.length > 0 && !selectedProject" class="empty-state">
    <div class="empty-icon">
      <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M24 4L30 16H38L32 24L36 36L24 30L12 36L16 24L10 16H18L24 4Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    </div>
    <p class="empty-title">Select a project</p>
    <p class="empty-description">Choose a project from the dropdown above</p>
  </div>

  <!-- Messages Container -->
  <div
    *ngIf="selectedProject"
    class="messages-container"
    #messageContainer
  >
    <!-- Loading State -->
    <div *ngIf="loadingMessages" class="loading-state">
      <div class="skeleton-message" *ngFor="let i of [1,2,3]">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-content">
          <div class="skeleton-line"></div>
          <div class="skeleton-line short"></div>
        </div>
      </div>
    </div>

    <!-- Message Error -->
    <div *ngIf="messageError && !loadingMessages" class="message-error" role="alert">
      <span>{{ messageError }}</span>
      <button class="btn-retry-small" (click)="loadMessages(selectedProject.id)">
        Retry
      </button>
    </div>

    <!-- Empty State: No Messages -->
    <div *ngIf="!loadingMessages && messages.length === 0 && !messageError" class="empty-messages">
      <div class="empty-icon-small">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 8C4 6.89543 4.89543 6 6 6H26C27.1046 6 28 6.89543 28 8V20C28 21.1046 27.1046 22 26 22H11L4 28V8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <circle cx="12" cy="14" r="1.5" fill="currentColor"/>
          <circle cx="16" cy="14" r="1.5" fill="currentColor"/>
          <circle cx="20" cy="14" r="1.5" fill="currentColor"/>
        </svg>
      </div>
      <p class="empty-messages-text">Start a conversation...</p>
    </div>

    <!-- Messages List -->
    <div *ngIf="!loadingMessages && messages.length > 0" class="messages-list">
      <div
        *ngFor="let message of messages; trackBy: trackByMessageId"
        class="message"
        [class.user-message]="message.role === 'user'"
        [class.assistant-message]="message.role === 'assistant'"
      >
        <div class="message-avatar">
          <span *ngIf="message.role === 'user'" class="avatar-icon user-avatar">U</span>
          <span *ngIf="message.role === 'assistant'" class="avatar-icon assistant-avatar">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 2L9.5 5.5L13 7L9.5 8.5L8 12L6.5 8.5L3 7L6.5 5.5L8 2Z" fill="currentColor"/>
            </svg>
          </span>
        </div>
        <div class="message-content">
          <p class="message-text">{{ message.content }}</p>
          <span class="message-time">{{ message.created_at | date: 'short' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div *ngIf="selectedProject" class="input-area">
    <div class="input-container">
      <textarea
        class="message-input"
        [(ngModel)]="messageInput"
        (keydown)="onKeydown($event)"
        [disabled]="sendingMessage"
        placeholder="Type a message..."
        rows="1"
        aria-label="Message input"
      ></textarea>

      <button
        class="btn-send"
        (click)="sendMessage()"
        [disabled]="!messageInput.trim() || sendingMessage"
        [attr.aria-busy]="sendingMessage"
        aria-label="Send message"
      >
        <svg
          *ngIf="!sendingMessage"
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>

        <svg
          *ngIf="sendingMessage"
          class="spinner"
          width="20"
          height="20"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle
            cx="10"
            cy="10"
            r="8"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-dasharray="40"
            stroke-dashoffset="10"
          />
        </svg>
      </button>
    </div>
  </div>
</div>
