# Backend API Documentation

**Generated by**: Backend Agent
**Date**: 2025-11-09
**Purpose**: Handoff document for Frontend Agent to generate Angular application

---

## Overview

This document describes the backend API generated from the database schema. The backend is built with NestJS and uses Supabase for data persistence and authentication.

**Application Type**: Lovable-style chat application
**Total Modules**: 2 (Projects, Messages)
**Authentication**: JWT-based via Supabase Auth
**Database**: PostgreSQL with Supabase

---

## Base URL

**Development**: `http://localhost:3333`
**API Documentation**: `http://localhost:3333/api` (Swagger UI)

---

## OpenAPI Specification

**Location**: `backend/openapi.json`

The complete API specification is available in OpenAPI 3.0 format. Use this for generating frontend API clients and TypeScript types.

---

## Authentication

The API uses JWT-based authentication via Supabase.

### Authentication Flow

1. **Sign Up/Sign In**: Use Supabase client on the frontend
   ```typescript
   const { data, error } = await supabase.auth.signInWithPassword({
     email: 'user@example.com',
     password: 'password'
   });
   ```

2. **Extract Token**: Get the access token from the session
   ```typescript
   const token = data.session.access_token;
   ```

3. **Include in Requests**: Add to Authorization header
   ```
   Authorization: Bearer <jwt_token>
   ```

### Protected Endpoints

**All endpoints require authentication** except for health check endpoints (`/`, `/health`).

Protected endpoints use:
- `@UseGuards(AuthGuard)` decorator
- `@ApiBearerAuth('JWT-auth')` for Swagger documentation
- Automatic user context extraction via `@CurrentUser()` decorator

### User Context

The authenticated user is automatically extracted from the JWT token and made available in controllers:

```typescript
@Get()
findAll(@CurrentUser() user: User) {
  // user.id is automatically extracted from JWT
  return this.service.findAll(user.id);
}
```

---

## API Endpoints

### Projects

**Base path**: `/projects`

Manage user projects that contain chat conversations.

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/projects` | Required | Create a new project |
| GET | `/projects` | Required | Get all user's projects |
| GET | `/projects/:id` | Required | Get a single project |
| PATCH | `/projects/:id` | Required | Update a project |
| DELETE | `/projects/:id` | Required | Delete a project |

#### POST /projects

Create a new project for the authenticated user.

**Request Body**:
```typescript
{
  name: string;          // required, max 255 chars
  description?: string;  // optional
}
```

**Response** (201 Created):
```typescript
{
  id: string;              // UUID
  user_id: string;         // UUID (from JWT)
  name: string;
  description: string | null;
  created_at: string;      // ISO 8601 timestamp
  updated_at: string;      // ISO 8601 timestamp
}
```

**Example**:
```bash
curl -X POST http://localhost:3333/projects \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"name": "My Chat App", "description": "A Lovable-style chat"}'
```

#### GET /projects

Get all projects for the authenticated user, sorted by creation date (newest first).

**Response** (200 OK):
```typescript
[
  {
    id: string;
    user_id: string;
    name: string;
    description: string | null;
    created_at: string;
    updated_at: string;
  }
]
```

#### GET /projects/:id

Get a single project by ID. Verifies ownership.

**Parameters**:
- `id` (path): Project UUID

**Response** (200 OK): Same as single project object

**Errors**:
- 404: Project not found or user doesn't have access

#### PATCH /projects/:id

Update a project. Verifies ownership.

**Parameters**:
- `id` (path): Project UUID

**Request Body**:
```typescript
{
  name?: string;         // optional, max 255 chars
  description?: string;  // optional
}
```

**Response** (200 OK): Updated project object

**Errors**:
- 404: Project not found or user doesn't have access

#### DELETE /projects/:id

Delete a project and all associated messages (cascading delete).

**Parameters**:
- `id` (path): Project UUID

**Response** (204 No Content): Empty response

**Errors**:
- 404: Project not found or user doesn't have access

---

### Messages

**Base path**: `/messages`

Manage chat messages within projects with mock AI responses.

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/messages/projects/:projectId` | Required | Create message + get mock AI response |
| GET | `/messages/projects/:projectId` | Required | Get all messages for a project |
| GET | `/messages/:id` | Required | Get a single message |
| PATCH | `/messages/:id` | Required | Update a message |
| DELETE | `/messages/:id` | Required | Delete a message |

#### POST /messages/projects/:projectId

Create a new user message and automatically generate a mock AI assistant response.

**Parameters**:
- `projectId` (path): Project UUID

**Request Body**:
```typescript
{
  content: string;  // required, the user's message
}
```

**Response** (201 Created):
Returns an array with TWO messages: [userMessage, assistantMessage]

```typescript
[
  {
    id: string;              // UUID
    project_id: string;      // UUID
    user_id: string;         // UUID (from JWT)
    content: string;         // User's message
    role: "user";
    created_at: string;      // ISO 8601
    updated_at: string;      // ISO 8601
  },
  {
    id: string;
    project_id: string;
    user_id: string;
    content: string;         // "This is a mock response to: [user's message]"
    role: "assistant";
    created_at: string;
    updated_at: string;
  }
]
```

**Example**:
```bash
curl -X POST http://localhost:3333/messages/projects/123e4567-... \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"content": "How do I build a chat app?"}'
```

**Important**: This endpoint creates TWO messages:
1. The user's message with `role: "user"`
2. A mock assistant response with `role: "assistant"` and content: `"This is a mock response to: [user's message]"`

This mock response will be replaced with real AI integration in the future.

#### GET /messages/projects/:projectId

Get all messages for a project in chronological order (oldest first).

**Parameters**:
- `projectId` (path): Project UUID

**Response** (200 OK):
```typescript
[
  {
    id: string;
    project_id: string;
    user_id: string;
    content: string;
    role: "user" | "assistant";
    created_at: string;
    updated_at: string;
  }
]
```

Messages are sorted by `created_at ASC` for chat display.

**Errors**:
- 404: Project not found or user doesn't have access

#### GET /messages/:id

Get a single message by ID. Verifies user owns the project.

**Parameters**:
- `id` (path): Message UUID

**Response** (200 OK): Single message object

**Errors**:
- 404: Message not found or user doesn't have access

#### PATCH /messages/:id

Update a message's content. Verifies ownership via project.

**Parameters**:
- `id` (path): Message UUID

**Request Body**:
```typescript
{
  content?: string;  // optional
}
```

**Response** (200 OK): Updated message object

**Errors**:
- 404: Message not found or user doesn't have access

#### DELETE /messages/:id

Delete a message. Verifies ownership via project.

**Parameters**:
- `id` (path): Message UUID

**Response** (204 No Content): Empty response

**Errors**:
- 404: Message not found or user doesn't have access

---

## Data Models

### Project Entity

```typescript
interface Project {
  id: string;              // UUID, auto-generated
  user_id: string;         // UUID, from JWT (owner)
  name: string;            // Required, max 255 chars
  description: string | null;  // Optional
  created_at: Date;        // Auto-generated
  updated_at: Date;        // Auto-updated
}
```

### Message Entity

```typescript
interface Message {
  id: string;              // UUID, auto-generated
  project_id: string;      // UUID, FK to projects
  user_id: string;         // UUID, from JWT (owner)
  content: string;         // Required, message text
  role: 'user' | 'assistant';  // Required, enum
  created_at: Date;        // Auto-generated
  updated_at: Date;        // Auto-updated
}
```

---

## Error Responses

All endpoints return standard HTTP error codes with JSON error messages.

### Standard Error Format

```typescript
{
  statusCode: number;
  message: string | string[];
  error?: string;
}
```

### Common Status Codes

- **200 OK**: Request succeeded
- **201 Created**: Resource created successfully
- **204 No Content**: Resource deleted successfully
- **400 Bad Request**: Invalid input data (validation failed)
  ```json
  {
    "statusCode": 400,
    "message": ["name should not be empty"],
    "error": "Bad Request"
  }
  ```
- **401 Unauthorized**: Missing or invalid authentication token
  ```json
  {
    "statusCode": 401,
    "message": "Invalid or expired token",
    "error": "Unauthorized"
  }
  ```
- **403 Forbidden**: Authenticated but not authorized (ownership check failed)
- **404 Not Found**: Resource does not exist
  ```json
  {
    "statusCode": 404,
    "message": "Project with ID abc-123 not found",
    "error": "Not Found"
  }
  ```
- **500 Internal Server Error**: Server-side error

---

## Validation Rules

### CreateProjectDto

- `name`:
  - Type: string
  - Required: yes
  - Constraints: NotEmpty, MaxLength(255)
- `description`:
  - Type: string
  - Required: no
  - Constraints: None

### UpdateProjectDto

- `name`:
  - Type: string
  - Required: no
  - Constraints: MaxLength(255)
- `description`:
  - Type: string
  - Required: no
  - Constraints: None

### CreateMessageDto

- `content`:
  - Type: string
  - Required: yes
  - Constraints: NotEmpty

### UpdateMessageDto

- `content`:
  - Type: string
  - Required: no
  - Constraints: None

---

## Security & Authorization

### Row Level Security (RLS)

All database operations are protected by Supabase RLS policies:

1. **Projects**:
   - Users can only see/modify their own projects
   - Enforced via `user_id = auth.uid()` in RLS policies

2. **Messages**:
   - Users can only see/modify messages for projects they own
   - Verified by JOIN with projects table in RLS policies

### Backend Verification

In addition to RLS, the backend:
1. Extracts user ID from JWT token (never trusts request body)
2. Passes user ID to all service methods
3. Explicitly filters queries by `user_id`
4. Verifies project ownership before creating/accessing messages

### Best Practices

- Never send `user_id` in request bodies (ignored by backend)
- Always include JWT token in Authorization header
- Handle 401/403 errors by redirecting to login
- Refresh tokens before expiration (3600s default)

---

## Next Steps for Frontend Agent

### 1. Generate TypeScript API Client

From the `frontend` directory:

```bash
npm run generate:api
```

This will:
- Read `../backend/openapi.json`
- Generate TypeScript types in `frontend/src/@api/types.ts`
- Create type-safe interfaces for all DTOs and entities

### 2. Use Generated Types

Import generated types in your Angular services:

```typescript
import { components } from '@api/types';

type Project = components['schemas']['Project'];
type CreateProjectDto = components['schemas']['CreateProjectDto'];
type Message = components['schemas']['Message'];
```

### 3. Create Angular Services

#### ProjectsService

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { components } from '@api/types';

type Project = components['schemas']['Project'];
type CreateProjectDto = components['schemas']['CreateProjectDto'];
type UpdateProjectDto = components['schemas']['UpdateProjectDto'];

@Injectable({ providedIn: 'root' })
export class ProjectsService {
  private apiUrl = 'http://localhost:3333/projects';

  constructor(private http: HttpClient) {}

  create(dto: CreateProjectDto): Observable<Project> {
    return this.http.post<Project>(this.apiUrl, dto);
  }

  findAll(): Observable<Project[]> {
    return this.http.get<Project[]>(this.apiUrl);
  }

  findOne(id: string): Observable<Project> {
    return this.http.get<Project>(`${this.apiUrl}/${id}`);
  }

  update(id: string, dto: UpdateProjectDto): Observable<Project> {
    return this.http.patch<Project>(`${this.apiUrl}/${id}`, dto);
  }

  remove(id: string): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

#### MessagesService

```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
import { components } from '@api/types';

type Message = components['schemas']['Message'];
type CreateMessageDto = components['schemas']['CreateMessageDto'];

@Injectable({ providedIn: 'root' })
export class MessagesService {
  private apiUrl = 'http://localhost:3333/messages';

  constructor(private http: HttpClient) {}

  create(projectId: string, dto: CreateMessageDto): Observable<Message[]> {
    return this.http.post<Message[]>(
      `${this.apiUrl}/projects/${projectId}`,
      dto
    );
  }

  findByProject(projectId: string): Observable<Message[]> {
    return this.http.get<Message[]>(
      `${this.apiUrl}/projects/${projectId}`
    );
  }

  remove(id: string): Observable<void> {
    return this.http.delete<void>(`${this.apiUrl}/${id}`);
  }
}
```

### 4. HTTP Interceptor for Authentication

Create an interceptor to automatically add JWT tokens:

```typescript
import { Injectable } from '@angular/core';
import {
  HttpInterceptor,
  HttpRequest,
  HttpHandler,
  HttpEvent,
} from '@angular/common/http';
import { Observable, from, switchMap } from 'rxjs';
import { createClient } from '@supabase/supabase-js';

@Injectable()
export class AuthInterceptor implements HttpInterceptor {
  private supabase = createClient(
    'http://localhost:8000',
    'your-anon-key'
  );

  intercept(
    req: HttpRequest<any>,
    next: HttpHandler
  ): Observable<HttpEvent<any>> {
    return from(this.supabase.auth.getSession()).pipe(
      switchMap(({ data: { session } }) => {
        if (session?.access_token) {
          req = req.clone({
            setHeaders: {
              Authorization: `Bearer ${session.access_token}`,
            },
          });
        }
        return next.handle(req);
      })
    );
  }
}
```

### 5. Error Handling

Create a global error handler:

```typescript
import { Injectable } from '@angular/core';
import { HttpErrorResponse } from '@angular/common/http';
import { Router } from '@angular/router';

@Injectable({ providedIn: 'root' })
export class ErrorHandlerService {
  constructor(private router: Router) {}

  handle(error: HttpErrorResponse) {
    if (error.status === 401) {
      // Redirect to login
      this.router.navigate(['/login']);
    } else if (error.status === 404) {
      // Show not found message
      console.error('Resource not found');
    } else {
      // Generic error
      console.error('An error occurred:', error.message);
    }
  }
}
```

### 6. UI Implementation Notes

#### Chat Interface

For the messages endpoint that returns two messages (user + assistant):

```typescript
sendMessage(projectId: string, content: string) {
  this.messagesService.create(projectId, { content }).subscribe({
    next: (messages) => {
      // messages[0] is the user message
      // messages[1] is the mock assistant response
      this.chatMessages.push(...messages);
    },
    error: (err) => this.errorHandler.handle(err),
  });
}
```

#### Message Display

Differentiate user and assistant messages using the `role` field:

```html
<div *ngFor="let message of messages"
     [class.user-message]="message.role === 'user'"
     [class.assistant-message]="message.role === 'assistant'">
  <p>{{ message.content }}</p>
  <small>{{ message.created_at | date:'short' }}</small>
</div>
```

---

## Development Workflow

### Starting the Backend

```bash
cd backend
npm install
npm run start:dev
```

The API will be available at:
- API: http://localhost:3333
- Swagger UI: http://localhost:3333/api

### Running Tests

```bash
cd backend
npm run test          # Unit tests
npm run test:e2e      # E2E tests
npm run test:cov      # Coverage report
```

### Database Setup

Ensure Supabase is running:

```bash
docker compose up -d postgres
```

Database migrations in `database/init/` are auto-applied on startup.

---

## API Features

### Implemented Features

✅ Full CRUD for Projects
✅ Full CRUD for Messages
✅ JWT-based authentication
✅ Automatic user context extraction
✅ Project ownership verification
✅ Message ownership verification via project
✅ Mock AI response generation
✅ Chronological message ordering
✅ Cascading deletes (project → messages)
✅ Input validation with class-validator
✅ OpenAPI/Swagger documentation
✅ Global exception handling
✅ CORS enabled for frontend

### Future Enhancements

⏳ Real AI integration (replace mock responses)
⏳ Message pagination
⏳ Real-time updates via Supabase subscriptions
⏳ Message search functionality
⏳ File upload support
⏳ Rate limiting
⏳ Request logging & monitoring

---

## TypeScript Types Reference

### Complete Type Definitions

For the most accurate and up-to-date types, always refer to the generated `frontend/src/@api/types.ts` file after running `npm run generate:api`.

**Example usage**:

```typescript
import { components, paths } from '@api/types';

// Entity types
type Project = components['schemas']['Project'];
type Message = components['schemas']['Message'];

// DTO types
type CreateProjectDto = components['schemas']['CreateProjectDto'];
type UpdateProjectDto = components['schemas']['UpdateProjectDto'];
type CreateMessageDto = components['schemas']['CreateMessageDto'];

// Endpoint types
type GetProjectsResponse = paths['/projects']['get']['responses']['200']['content']['application/json'];
type CreateMessageResponse = paths['/messages/projects/{projectId}']['post']['responses']['201']['content']['application/json'];
```

---

## Contact & Support

### Debugging

- Check backend logs: `npm run start:dev` shows all requests
- Verify JWT token: Use https://jwt.io to decode tokens
- Test endpoints: Use Swagger UI at http://localhost:3333/api
- Database queries: Check Supabase Studio or pgAdmin

### Common Issues

**401 Unauthorized**:
- Verify JWT token is not expired
- Check Authorization header format: `Bearer <token>`
- Ensure user is signed in via Supabase

**404 Not Found**:
- Verify resource ID is correct UUID
- Check user owns the resource (projects/messages)
- Ensure resource exists in database

**400 Bad Request**:
- Check request body matches DTO validation
- Verify all required fields are present
- Check field types and constraints

---

**End of Backend API Documentation**
